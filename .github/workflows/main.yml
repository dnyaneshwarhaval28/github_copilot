name: Github Copilot Automation Tests  # Workflow name shown in GitHub Actions UI

on:
  # Trigger workflow on push to main branch
  push:
    branches: [ "main" ]

  # Trigger workflow on pull request to main branch
  pull_request:
    branches: [ "main" ]

  # Allow manual trigger from GitHub Actions UI
  workflow_dispatch:

  # Schedule daily run at 02:30 AM UTC (08:00 AM IST)
  schedule:
    - cron: "30 2 * * *"

jobs:
  test:
    # Use Ubuntu runner
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Setup Python environment
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Step 3: Install project dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip          # Upgrade pip
          pip install -r requirements.txt             # Install Python dependencies
          playwright install --with-deps             # Install Playwright browsers & dependencies
          pip show allure-pytest || echo "⚠️ allure-pytest not installed"  # Verify Allure plugin

      # Step 4: Run Pytest tests with HTML & Allure reports
      - name: Run Pytest tests
        run: |
          mkdir -p reports                           # Create reports folder
          mkdir -p reports/allure-results            # Create Allure results folder
          
          # Run tests and generate reports
          pytest -v tests \
            --html=reports/report.html \
            --self-contained-html \
            --alluredir=reports/allure-results || true

      # Step 5: Debug - Check Allure results folder (helps in troubleshooting)
      - name: Debug Allure Results
        if: always()
        run: |
          echo "===== Allure Results Files ====="
          ls -R reports/allure-results || true

      # Step 6: Install Allure CLI (required to generate HTML report)
      - name: Install Allure CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y default-jre        # Install Java (required for Allure)
          
          # Download and install Allure CLI
          curl -o allure.tgz -Ls https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
          tar -zxvf allure.tgz
          sudo mv allure-2.27.0 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/bin/allure

      # Step 7: Generate Allure HTML Report (only if results exist)
      - name: Generate Allure Report
        if: always()
        run: |
          # Check if Allure results exist before generating report
          if [ -d "reports/allure-results" ] && [ "$(ls -A reports/allure-results)" ]; then
            echo "✅ Allure results found. Generating report..."
            mkdir -p reports/allure-report
            allure generate reports/allure-results --clean -o reports/allure-report --single-file
          else
            echo "⚠️ No Allure results found. Skipping report generation."
          fi

      # Step 8: Upload Pytest HTML Report as GitHub Artifact
      - name: Upload Pytest HTML Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-report
          path: reports/report.html

      # Step 9: Upload Allure Report as GitHub Artifact
      - name: Upload Allure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: reports/allure-report